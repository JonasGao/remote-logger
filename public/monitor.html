<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>监视器</title>
    <link rel="stylesheet" type="text/css" href="./monitor.css" />
  </head>
  <body>
    <div class="container">
      <div class="side-bar">
        <button class="auto-scroll active" onclick="switchAutoScroll(event)">自动滚动(快捷键 a)</button>
      </div>
      <div class="log-container">
        <p id="logList"></p>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const option = {
        autoScroll: true
      };

      const socket = io("/monitor", {
        transports: ["websocket"]
      });

      const logList = document.getElementById("logList");

      const appendLog = (id, data) => {
        const logCode = document.createElement("code");
        const logPre = document.createElement("pre");
        logCode.appendChild(logPre);
        if (typeof data === "object") {
          if (data.app) {
            data = `[app] ${data.app} [content] ${data.content}`;
          } else {
            data = `[content] ${JSON.stringify(data)}`;
          }
        } else {
          data = `[content] ${data}`;
        }

        logPre.innerHTML = `[来自设备] ${id} ${data}`;

        logList.appendChild(logCode);
      };

      const scrollToBottom = () => {
        if (option.autoScroll) {
          scroll({
            top: document.body.scrollHeight,
            left: 0,
            behavior: 'smooth'
          });
        }
      }

      const switchAutoScroll = event => {
        option.autoScroll = !option.autoScroll;
        event.target.classList.toggle("active")
      }

      socket.on("log", ({id, data}) => {
        console.log("reciving [id]", id, "[data]", data);
        appendLog(id, data);
        scrollToBottom();
      });

      document.addEventListener('keyup', event => {
        if (event.key === 'a') {
          document.querySelector('.auto-scroll').dispatchEvent(new MouseEvent('click'))
        }
      })
    </script>
  </body>
</html>
