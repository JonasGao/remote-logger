<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>监视器</title>
    <link rel="stylesheet" type="text/css" href="./monitor.css" />
  </head>
  <body>
    <div class="container">
      <div class="side-bar">
        <button
          class="auto-scroll btn active"
          onclick="switchAutoScroll(event)"
        >
          自动滚动(快捷键 a)
        </button>
        <button class="toggle-log btn" onclick="toggleLog(event)">
          停止接收(快捷键 s)
        </button>
      </div>
      <div class="log-container">
        <log-list id="list0" />
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/monitor.js"></script>
    <script>
      const option = {
        autoScroll: true,
        stop: false
      };

      const socket = io("/monitor", {
        transports: ["websocket"]
      });

      const logList = document.getElementById("list0");

      const getLevelColor = level => {
        switch (level) {
          case "DEBUG":
            return "blue";
          case "ERROR":
            return "red";
        }
      };

      const getLevelMark = level => {
        const span = document.createElement("span");
        span.innerHTML = level;
        span.style.color = getLevelColor(level);
        return span;
      };

      const appendLog = (id, data) => {
        const [
          setId,
          setApp,
          setTime,
          setLogger,
          setLevel,
          setContent
        ] = logList.addRow();
        setId(id);
        switch (data.v) {
          case 0:
            setContent(data.content);
            break;
          case 1:
            setApp(data.app);
            setTime(data.time);
            setLogger(data.logger);
            setLevel(getLevelMark(data.level));
            setContent(data.content);
            break;
          default:
            if (typeof data !== "string") {
              setContent(JSON.stringify(data));
            } else {
              setContent(data);
            }
            break;
        }
      };

      const scrollToBottom = () => {
        if (option.autoScroll) {
          scroll({
            top: document.body.scrollHeight,
            left: 0,
            behavior: "smooth"
          });
        }
      };

      const switchAutoScroll = event => {
        option.autoScroll = !option.autoScroll;
        event.target.classList.toggle("active");
      };

      const toggleLog = event => {
        option.stop = !option.stop;
        appendLog("", option.stop ? "停止" : "开始");
        event.target.classList.toggle("active");
      };

      socket.on("log", ({ id, data }) => {
        console.log("reciving [id]", id, "[data]", data);
        if (option.stop) {
          return;
        }
        appendLog(id, data);
        scrollToBottom();
      });

      document.addEventListener("keyup", event => {
        switch (event.key) {
          case "a":
            document
              .querySelector(".auto-scroll")
              .dispatchEvent(new MouseEvent("click"));
            break;
          case "s":
            document
              .querySelector(".toggle-log")
              .dispatchEvent(new MouseEvent("click"));
            break;
        }
      });
    </script>
  </body>
</html>
