<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>监视器</title>
    <link rel="stylesheet" type="text/css" href="./monitor.css" />
  </head>
  <body>
    <div class="container">
      <div class="side-bar">
        <button class="auto-scroll active" onclick="switchAutoScroll(event)">自动滚动(快捷键 a)</button>
      </div>
      <div class="log-container">
        <log-list id="list0"/>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/monitor.js"></script>
    <script>
      const option = {
        autoScroll: true
      };

      const socket = io("/monitor", {
        transports: ["websocket"]
      });

      const logList = document.getElementById("list0");

      const appendLog = (id, data) => {
        const [setLogInfo, setLogContent] = logList.addRow()

        if (typeof data === "object") {
          if (data.v === 1) {
            setLogInfo(`${id}@${data.app}@${data.time} [${data.logger}]:[${data.level}]`)
            setLogContent(data.content)
          } else if (data.app) {
            setLogInfo(`[app] ${data.app}`)
            setLogContent(data.content)
          } else {
            setLogContent(JSON.stringify(data))
          }
        } else {
          setLogContent(data)
        }
      };

      const scrollToBottom = () => {
        if (option.autoScroll) {
          scroll({
            top: document.body.scrollHeight,
            left: 0,
            behavior: 'smooth'
          });
        }
      }

      const switchAutoScroll = event => {
        option.autoScroll = !option.autoScroll;
        event.target.classList.toggle("active")
      }

      socket.on("log", ({id, data}) => {
        console.log("reciving [id]", id, "[data]", data);
        appendLog(id, data);
        scrollToBottom();
      });

      document.addEventListener('keyup', event => {
        if (event.key === 'a') {
          document.querySelector('.auto-scroll').dispatchEvent(new MouseEvent('click'))
        }
      })
    </script>
  </body>
</html>
