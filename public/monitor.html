<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>监视器</title>
    <link rel="stylesheet" type="text/css" href="./monitor.css" />
  </head>
  <body>
    <div class="container">
      <div class="tool-bar">
        <button
          class="auto-scroll btn active"
          onclick="switchAutoScroll(event)"
        >
          自动滚动(快捷键 a)
        </button>
        <button class="toggle-log btn" onclick="toggleLog(event)">
          停止接收(快捷键 s)
        </button>
        <label class="txt">
          <input type="text" id="filter"/>
        </label>
        <button class="btn primary" onclick="applyFilter(event)">
          应用过滤
        </button>
        <button class="btn second" onclick="clearFilter(event)">
          重置
        </button>
      </div>
      <div class="log-container">
        <log-list id="list0"></log-list>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/monitor.js"></script>
    <script>
      const option = {
        autoScroll: true,
        stop: false,
        filter: null,
      };

      const socket = io("/monitor", {
        transports: ["websocket"]
      });

      const logList = document.getElementById("list0");

      const getLevelColor = level => {
        switch (level) {
          case "DEBUG":
            return "blue";
          case "ERROR":
            return "red";
        }
      };

      const getLevelMark = level => {
        const span = document.createElement("span");
        span.innerHTML = level;
        span.style.color = getLevelColor(level);
        return span;
      };

      const appendLog = (id, data) => {
        const [
          setId,
          setApp,
          setTime,
          setLogger,
          setLevel,
          setContent
        ] = logList.addRow();
        setId(id);
        switch (data.v) {
          case 0:
            setContent(data.content);
            break;
          case 1:
            setApp(data.app);
            setTime(data.time);
            setLogger(data.logger);
            setLevel(getLevelMark(data.level));
            setContent(data.content);
            break;
          default:
            if (typeof data !== "string") {
              setContent(JSON.stringify(data));
            } else {
              setContent(data);
            }
            break;
        }
      };

      const scrollToBottom = () => {
        if (option.autoScroll) {
          scroll({
            top: document.body.scrollHeight,
            left: 0,
            behavior: "smooth"
          });
        }
      };

      const switchAutoScroll = event => {
        option.autoScroll = !option.autoScroll;
        event.target.classList.toggle("active");
      };

      const toggleLog = event => {
        option.stop = !option.stop;
        appendLog("", option.stop ? "停止" : "开始");
        event.target.classList.toggle("active");
      };

      const applyFilter = () => {
        const pattern = document.getElementById('filter').value;
        localStorage.setItem('filter', pattern)
        option.filter = new RegExp(pattern)
        appendLog("", '过滤应用');
      }

      const clearFilter = () => {
        option.filter = null;
        appendLog("", '停止过滤应用');
      }

      const doFilter = data => {
        if (data.app && option.filter) {
          return !option.filter.test(data.app)
        } else {
          return false
        }
      }

      socket.on("log", ({ id, data }) => {
        console.debug("reciving [id]", id, "[data]", data);
        if (option.stop) {
          return;
        }
        if (doFilter(data)) {
          return
        }
        appendLog(id, data);
        scrollToBottom();
      });

      document.addEventListener("keyup", event => {
        if (event.target instanceof HTMLInputElement) {
          console.log('skip hotkey')
          return
        }
        switch (event.key) {
          case "a":
            document
              .querySelector(".auto-scroll")
              .dispatchEvent(new MouseEvent("click"));
            break;
          case "s":
            document
              .querySelector(".toggle-log")
              .dispatchEvent(new MouseEvent("click"));
            break;
        }
      });

      const pattern = localStorage.getItem('filter');
      document.getElementById('filter').value = pattern;
    </script>
  </body>
</html>
